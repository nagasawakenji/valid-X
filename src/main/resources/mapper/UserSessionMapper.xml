<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Nagasawa.valid_X.infra.mybatis.mapper.UserSessionMapper">

    <resultMap id="UserSessionMap" type="Nagasawa.valid_X.domain.model.UserSession">
        <id     property="id"              column="id"/>
        <result property="userId"          column="user_id"/>
        <result property="sessionVersion"  column="session_version"/>
        <result property="createdAt"       column="created_at"/>
        <result property="lastSeenAt"      column="last_seen_at"/>
        <result property="revokedAt"       column="revoked_at"/>
        <result property="expiresAt"       column="expires_at"/>
    </resultMap>

    <insert id="insert"
            parameterType="Nagasawa.valid_X.domain.model.UserSession"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO user_sessions (
        user_id, session_version, created_at, last_seen_at, revoked_at, expires_at
        ) VALUES (
        #{userId},
        #{sessionVersion},
        #{createdAt},
        #{lastSeenAt},
        #{revokedAt},
        #{expiresAt}
        )
        RETURNING id
    </insert>

    <select id="findById" resultMap="UserSessionMap">
        SELECT id, user_id, session_version, created_at, last_seen_at, revoked_at, expires_at
        FROM user_sessions
        WHERE id = #{id}
    </select>

    <update id="updateLastSeen">
        UPDATE user_sessions SET last_seen_at = #{ts} WHERE id = #{id}
    </update>

    <update id="bumpVersion">
        UPDATE user_sessions SET session_version = session_version + 1 WHERE id = #{id}
    </update>

    <update id="revoke">
        UPDATE user_sessions SET revoked_at = #{ts} WHERE id = #{id} AND revoked_at IS NULL
    </update>

</mapper>